# Ortholgy inference

When setting up a phylogenetic/phylogenomic project, the first necessary step is identify **ortologs genes..**

## Orthologs, Paralogs and Orthogroups

### What are orthologs and paralogs genes?

  * Orthologs are commonly defined as pairs of genes that started diverging after **speciations** events.  
  * Paragols genes, on contrary, started diverging after **duplication** events.  
 
### Why in phylogenetics inference we are interested in strictly orhologs genes?

*"Phylogenies require orthologous, not paralogous genes"* [Walter M. Fitch](https://academic.oup.com/sysbio/article-abstract/19/2/99/1655771).  

By definition, since orthologs genes arise by speciation events, they share the same evolutionary history of the underlying species. Moreover, beside phylogentics, orthologs genes should share the same **biological function**, while paralgos genes are belivied to differ in function (‘ortholog conjecture’ [Nehrt et al., 2011](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1002073)).

However, as usual in biology, be aware of this latest corollary, recently ortholog conjecture has been largely questioned (see [Stamboulian et al., 2020](https://academic.oup.com/bioinformatics/article/36/Supplement_1/i219/5870499) and [Lynch and Conery, 2000](https://science.sciencemag.org/content/290/5494/1151.abstract?casa_token=xqdhpSn423QAAAAA:mi5ecKfOTYeHPuelYUEP0zBd7gM-fEVWJDjZktvNo-bfFX5XjY44ns7epbpUHi9DmqzPv7id9Km2jA), [Gout and Lynch, 2015](https://academic.oup.com/mbe/article/32/8/2141/2925587?login=true) for for some interesting hints on fate of duplicated genes )

**Just to make things more complex...**

### Classification of ortologs and paralogs

Orthology is **always** defined by phylogenetics and unit of comparison:

 1. **One-to-one ortologs:** in both species is present only one copy of the gene, arise after speciation event (x1 and y1, x2 and y2).
 2. **Many-to-one** and **one-to-many ortologs:** after specieation event, one or more duplication events occured in one of the two lineages, as a result we have **three or more** ortholog genes (x2 and z1)!
 3. **Many-to-many ortologs:** after speciation event, one or more duplications events occured in both lineages, as a result we have **multiple copies** of ortologs genes.
 4. **Paralogs:** (x1 and x2, x1 and y2)
 5. **In-paralogs:** is definied over a triplet. It involves a pair of genes and a speciation event of reference. A gene pair is an in-paralog if they are paralogs and duplicated after the speciation event of reference (x1 and y2 with respect to S1).
 6. **Out-paralogs:** is also a relation defined over a pair of genes and a speciation event of reference. This pair is out-paralogs if the duplication event through which they are related to each other predates the speciation event of reference (x1 and y2 with respect to S2).

![Example](https://github.com/for-giobbe/phy/blob/master/2021/Orthologs_Paralogs.png)

...and others (see chapter "Inferring Orthology and Paralogy" [Anisimova, 2019](https://core.ac.uk/download/pdf/289121767.pdf)).

### and Orthogroups?

An orthogroups is a group of orthologs genes descending from the **last common ancestor** (LCA) of a group of species. (*i.e.* extension of concept of orthology to multiple species). An orthogroup is always defined by a reference speciation event!

**In phylogenomics one of the most common things is to use only 1-to-1 ortologs** (Orthogroups with only one copy for each specie)

### How can we identify orthologs?

If we are setting up an experiment involving the Sanger sequencing of a marker, we should know *a priori* that all fragments are orthologs between each other (choose the markers and primers based on bibliography knowledge). A common way is to use mtDNA sequences and nuclear ribosomial RNA (*e.g.* 28s).

If we are dealing with NGS data such as transcriptomes or WGA we have a lot of nice software to choose from, one of the most popolar is...

## [Orthofinder](https://github.com/davidemms/OrthoFinder)

In brief, Orthofinder alghoritm is subdivided into 3 major steps:

 1. **Orthogroups inference** using *bi-directional best hit (BBH)*, costruction of orthogroup graph and clustering genes into discrete ortogroups.
 2. **gene trees** inference and rooting for each orthogroup.
 3. Inference of **orthologs and gene duplication events** using rooted gene trees.
 
The detailed explanation of each step is not the aim of this course, hoever if you are interested in orthology inference you should have a look at the two Orthofinder papers ([Emms and Kelly, 2015](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-015-0721-2?optIn=false) and [Emms and Kelly, 2019](https://genomebiology.biomedcentral.com/articles/10.1186/s13059-019-1832-y)). Just take in mind the extremely importance of the *bi-directional best hit*, indeed is the only way to take into account possible gene loss in one of the two lineages. (Think about what can happen in orthology inference  if the blue human gene in figure 1A would be lost...) 

Beside these teoretically, but important questions, one of the most valuable things about Orthofinder is its *usability*. A *quick-and-dirty* Orthofinder analyses can be simply run with:

```
orthofinder -f <proteoms_folder>
```

However we can also tune a lot of parameters. Let's take a look at them:

```
orthofinder --help

OrthoFinder version 2.5.2 Copyright (C) 2014 David Emms

SIMPLE USAGE:
Run full OrthoFinder analysis on FASTA format proteomes in <dir>
  orthofinder [options] -f <dir>

Add new species in <dir1> to previous run in <dir2> and run new analysis
  orthofinder [options] -f <dir1> -b <dir2>

OPTIONS:
 -t <int>        Number of parallel sequence search threads [Default = 4]
 -a <int>        Number of parallel analysis threads
 -d              Input is DNA sequences
 -M <txt>        Method for gene tree inference. Options 'dendroblast' & 'msa'
                 [Default = dendroblast]
 -S <txt>        Sequence search program [Default = diamond]
                 Options: blast, diamond, diamond_ultra_sens, blast_gz, mmseqs, blast_nucl
 -A <txt>        MSA program, requires '-M msa' [Default = mafft]
                 Options: mafft, muscle
 -T <txt>        Tree inference method, requires '-M msa' [Default = fasttree]
                 Options: fasttree, raxml, raxml-ng, iqtree
 -s <file>       User-specified rooted species tree
 -I <int>        MCL inflation parameter [Default = 1.5]
 -x <file>       Info for outputting results in OrthoXML format
 -p <dir>        Write the temporary pickle files to <dir>
 -1              Only perform one-way sequence search
 -X              Don't add species names to sequence IDs
 -y              Split paralogous clades below root of a HOG into separate HOGs
 -z              Don't trim MSAs (columns>=90% gap, min. alignment length 500)
 -n <txt>        Name to append to the results directory
 -o <txt>        Non-default results directory
 -h              Print this help text

WORKFLOW STOPPING OPTIONS:
 -op             Stop after preparing input files for BLAST
 -og             Stop after inferring orthogroups
 -os             Stop after writing sequence files for orthogroups
                 (requires '-M msa')
 -oa             Stop after inferring alignments for orthogroups
                 (requires '-M msa')
 -ot             Stop after inferring gene trees for orthogroups 

WORKFLOW RESTART COMMANDS:
 -b  <dir>         Start OrthoFinder from pre-computed BLAST results in <dir>
 -fg <dir>         Start OrthoFinder from pre-computed orthogroups in <dir>
 -ft <dir>         Start OrthoFinder from pre-computed gene trees in <dir>

LICENSE:
 Distributed under the GNU General Public License (GPLv3). See License.md

CITATION:
 When publishing work that uses OrthoFinder please cite:
 Emms D.M. & Kelly S. (2019), Genome Biology 20:238

 If you use the species tree in your work then please also cite:
 Emms D.M. & Kelly S. (2017), MBE 34(12): 3267-3278
 Emms D.M. & Kelly S. (2018), bioRxiv https://doi.org/10.1101/267914
```

There is a lot of stuff! IMO the most important parameters to take in mind are: ```-M```, ```-S```, ```-T``` and ```-s```. However for our purpose a *quick-and-dirty* orthofinder run is enough (but in real situation is better to play with parameters and find the more suitable for our data).
Now run our Orthofinder search:

```
orthofinder -o Analyses/Orthology_Inference_2 -f Data/Proteoms
```

**NB** the ```-o``` option will create a new output directory inside /Analyses. Kill the process, it will take to much time (almost 1 hours with 10 cores). A ready-to-use output folder is /Analyses/Orthology_Inference 

Now let's take a look at some of the outputs:

1: Summary tsv:

```
cat Analyses/Orthology_Inference/Results_Mar29/Comparative_Genomics_Statistics/Statistics_Overall.tsv
Number of species 8
Number of genes 200779
Number of genes in orthogroups 169908
Number of unassigned genes 30871
Percentage of genes in orthogroups 84.6
Percentage of unassigned genes 15.4
Number of orthogroups 20598
Number of species-specific orthogroups 6310
Number of genes in species-specific orthogroups 35010
Percentage of genes in species-specific orthogroups 17.4
Mean orthogroup size 8.2
Median orthogroup size 7.0
G50 (assigned genes) 10
G50 (all genes) 9
O50 (assigned genes) 4303
O50 (all genes) 5977
Number of orthogroups with all species present 4428
Number of single-copy orthogroups 1043
Date2021-03-29
Orthogroups fileOrthogroups.tsv
Unassigned genes fileOrthogroups_UnassignedGenes.tsv
Per-species statisticsStatistics_PerSpecies.tsv
Overall statisticsStatistics_Overall.tsv
Orthogroups shared between speciesOrthogroups_SpeciesOverlaps.tsv

Average number of genes per-species in orthogroup Number of orthogroups Percentage of orthogroups Number of genes Percentage of genes
<1 11686 56.7 45456 26.8
'1 7303 35.5 71240 41.9
'2 842 4.1 15636 9.2
'3 293 1.4 7990 4.7
'4 168 0.8 5836 3.4
'5 74 0.4 3197 1.9
'6 39 0.2 1998 1.2
'7 38 0.2 2250 1.3
'8 34 0.2 2302 1.4
'9 19 0.1 1438 0.8
'10 16 0.1 1331 0.8
11-15 59 0.3 6237 3.7
16-20 14 0.1 2047 1.2
21-50 12 0.1 2501 1.5
51-100 1 0.0 449 0.3
101-150 0 0.0 0 0.0
151-200 0 0.0 0 0.0
201-500 0 0.0 0 0.0
501-100 0 0 0.00 0.0
'1001+ 0 0.0 0 0.0

Number of species in orthogroup Number of orthogroups
1 6310
2 2469
3 1144
4 863
5 1021
6 1535
7 2828
8 4428
```
Explore the file and try to answer the following questions:

 * How many single copy Orthogroups have been found?
 * Which is the percentage of assigned genes?
 * In you opinion, how can the inclusion of more taxa influence these statistics?


