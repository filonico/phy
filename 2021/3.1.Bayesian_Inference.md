# Building a Tree in a BI Framework

<br/>
<br/>

## intro: 

In this lesson we will use MrBayes [(Ronquist et al., 2012)](https://academic.oup.com/sysbio/article/61/3/539/1674894) to understand the underlying concepts of Bayesian Inference in phylogenetics. Remember that in a Bayesian framework we estimate parameters from their posterior distribution, instead of finding the best single estimates as in a Maximum Likelihood framework.

---

<br/>
<br/>

## MSA format conversion: 

Unfortunately, next steps of this tutorial will be very computanional intensive, for this reason we have to sub-sample our 1-to-1 gblocked alignments. We can randomly chose *n* alignments using a for loop and some simple bash commands:

```
mkdir -p Analyses/BI/Alignments
brew install coreutils #For MacOS users
for i in $(ls Analyses/1-to-1_Alignments/gblock | shuf -n 5); do varAL=$( find . -name "$i"); cp "$varAL" Analyses/BI/Alignments/; done
```

At this stage we have already used ```.fas``` and ```.nxs``` formats for Multiple Sequence Alignment. 
In this lesson we will also need a ```.phy``` - a phylip-formatted file - which is required by [PartitionFinder2](http://www.robertlanfear.com/partitionfinder/).
This format name comes from a very ancient piece of software - called of course [PHYLIP](https://en.wikipedia.org/wiki/PHYLIP) - which is turning 40 this year :-O
It is a very bare bone format which has in the first line the number of species and the number of characters (nucleotides, proteins, ...) separated by a space and subsequently one entry (whether species or specimen) for each line, with the sequence i.d. as the first element followed by a space and then by the sequence itself.

If you want to play with Bash you can write your own scripts to convert from different formats. Something like:

from ```.nxs``` to ```.fasta```:

```
awk '/MATRIX/,EOF { print $0 }' concatenation.nxs | tail +2 | tr  \\t ' ' | sed -e 's/^ />/' | tr ' ' '\n' | sed '$d' | sed '$d' | sed '$d' > concatenation.fasta
```

from ```.nxs``` to ```.phy```:

```
nxs=concatenation.nxs;
awk '/MATRIX/,EOF { print $0 }' $nxs | tail +2 | tr  \\t ' ' | sed 's/^ //g' | sed '$d' | sed '$d' | sed '$d' > tmp.phy; 
n_tax=$(head -4 $nxs | tail -1 | awk -F "NTAX=" '{print $2}' | awk '{print $1}');
n_car=$(head -4 $nxs | tail -1 | awk -F "NCHAR=" '{print $2}' | tr -d ";");
echo $n_tax $n_car > first_line.tmp; cat first_line.tmp tmp.phy > concatenation.phy; 
rm *tmp*
```

But usually Python it's much more convenient for these operations since it is less prone to bugs and most of the time you will find an already tested package that do it for you (saving you time, but if you just want to play with code you can practice yourself writing your own functions).

Since we have already installed AMAS we can use again its ```concat``` function but specifyng the phylip output format for the alignment and the Raxml format for the partition file (which will became our ```.cfg``` file):

```
AMAS.py concat -u phylip-int -y raxml -i Analyses/BI/Alignments/OG00000* -f fasta -d aa -p Analyses/BI/My_Partitions.txt -t Analyses/BI/My_concat.phy
```
---

Before the phylogenetic Bayesian Inference (BI), we have to carry out model selection again, mainly for two reasons:

* MrBayes supports slightly different models than ModelFinder (_e.g._ no base frequencies additional parameters)

* even if possible it's really painfull to translate / approximate models from ModelFinder to MrBayes.

We will take advantage of this situation to leverage PartitionFinder2 [(Lanfear et al., 2016)]( https://doi.org/10.1093/molbev/msw260) which can carry out the model selection specifically for MrBayes. This situation teaches us a lesson on usability and how sometimes phylogenetic pipeline consist in a straight process (ModelFinder -> IQ-TREE), but sometimes they result in a quite fragmented workflow with multiple tools and steps in between them.

As previously said the input of PartitionFinder2 are a ```.phy``` and a ```.cfg```.
The latter stands for configuration and is a quite widespread approach to customise analyses while using several pieces of software: all the options are found inside the configuration file, including all the inputs required for the analysis. For convenience, the input alignment is usually placed in the same folder where the configuration file is located, but a path can be specified as well.

For this purpose we have to reformat a bit the cfg file:

```
cat Analyses/BI/My_Partitions.txt | sed 's/^.....//g' | sed 's/$/;/g' > Analyses/BI/partition_finder.cfg
```

Now we have to manually change it following [this](http://www.robertlanfear.com/partitionfinder/tutorial/assets/partition_finder.cfg) pre-formatted configuration. You should already be familiar with many of the options, as they are quite similar to the ones of ModelFinder.
Here is how I configured my ```.cfg``` using ```vim``` :


```
cat Analyses/BI/partition_finder.cfg
## ALIGNMENT FILE ##
alignment = My_concat.phy;

## BRANCHLENGTHS: linked | unlinked ##
branchlengths = linked;

## MODELS OF EVOLUTION: all | allx | mrbayes | beast | gamma | gammai | <list> ##
models = mrbayes;

# MODEL SELECCTION: AIC | AICc | BIC #
model_selection = bic;

## DATA BLOCKS: see manual for how to define ##
[data_blocks]

p1_OG0000031 = 1-151;
p2_OG0000036 = 152-314;
p3_OG0000042 = 315-475;
p4_OG0000061 = 476-805;
p5_OG0000075 = 806-956;

## SCHEMES, search: all | user | greedy | rcluster | rclusterf | kmeans ##
[schemes]

search = rcluster;
```

